# Development
FROM golang:1.22.2-alpine AS development
WORKDIR /go/src/github.com/tidepool-org/platform
RUN apk --no-cache update && \
    apk --no-cache upgrade && \
    apk --no-cache add make git ca-certificates tzdata && \
    go install github.com/githubnemo/CompileDaemon@v1.4.0 && \
    adduser -D tidepool && \
    chmod -R go+w /go/pkg/mod && \
    chown -R tidepool:tidepool /go/src/github.com/tidepool-org/platform
USER tidepool
COPY --chown=tidepool:tidepool . .
ENV SERVICE=services/data
RUN ["make", "plugins-visibility"]
RUN ["make", "service-build"]
CMD ["make", "service-start"]

# Production
FROM alpine:latest AS production
RUN apk --no-cache update && \
    apk --no-cache upgrade && \
    apk add --no-cache ca-certificates tzdata && \
    adduser -D tidepool
WORKDIR /home/tidepool
USER tidepool
COPY --from=development --chown=tidepool:tidepool /go/src/github.com/tidepool-org/platform/_bin/services/data/ .
CMD ["./data"]
